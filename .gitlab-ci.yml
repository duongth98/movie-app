image: docker:latest
services:
  - docker:dind

stages:
  - builddocker
  - deploy
before_script:
  - export IMAGE="$CI_REGISTRY_IMAGE:master-$CI_COMMIT_SHA"
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
forbuilddocker:
  stage: builddocker
  tags: 
    - docker
  only:
    - develop
  script:
    - docker build -t $IMAGE .
    - docker push $IMAGE
    - docker rmi $IMAGE

deploy:
    stage: deploy
    image: mikefarah/yq:4
    before_script:
      # Define remote origin
      - git remote set-url origin "https://${USER_DEPLOY}:${PASSWORD}@gitlab.com/devops5660826/argocd/helm-chart-app.git"
      # Configure git user
      - git config --global user.email "phamduong812@gmail.com"
      - git config --global user.name "duongth"
      # Reset to remote main branch
      - git fetch

    script:
      # Update YAML file
      - cd helm-chart-app
      - git checkout dev
      - ls -la
      - cd movie-app
      - yq -i ''.image.tag' = "'master-$CI_COMMIT_SHA'"' values.yaml
      - git commit -am 'image update'
      - git push origin dev
    only:
      - develop
    tags:
      - docker
