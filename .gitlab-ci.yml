image: docker:latest
services:
  - docker:dind

stages:
  - builddocker
  - deploy
before_script:
  - export IMAGE="$CI_REGISTRY_IMAGE:master-$CI_COMMIT_SHA"
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
forbuilddocker:
  stage: builddocker
  only:
    - develop
  script:
    - docker build -t $IMAGE .
    - docker push $IMAGE
    - docker rmi $IMAGE


deploy:
  stage: deploy
  variables:
    GIT_STRATEGY: none
  before_script:
    - git config --global user.email "phamduong812@gmail.com"
    - git config --global user.name "DuongTH"
  script:
    - git clone https://${USER_DEPLOY}:${PASSWORD}@gitlab.com/devops5660826/argocd/helm-chart-app.git
    - cd helm-chart-app
    - git checkout dev
    - cd movie-app
    # - >
    #   docker run --rm
    #   --user="root"
    #   -v "${PWD}":/workspace
    #   -w /workspace
    #   mikefarah/yq:4
    #   eval ''.image.tag' = "master-456"' -i values.yaml
    - docker run --rm --user="root" -v "${PWD}":/workspace -w /workspace mikefarah/yq:4 eval ''.image.tag' = "'master-$CI_COMMIT_SHA'"' -i values.yaml
    - git add .
    - git commit -m " Update $CI_PROJECT_NAME image tag"
    - git push origin dev
  only:
    - develop

