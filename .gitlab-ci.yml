image: docker:latest
services:
  - docker:dind

stages:
  - builddocker
  - deploy
before_script:
  - export IMAGE="$CI_REGISTRY_IMAGE:master-$CI_COMMIT_SHA"
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
forbuilddocker:
  stage: builddocker
  tags: 
    - docker
  only:
    - develop
  script:
    - docker build -t $IMAGE .
    - docker push $IMAGE
    - docker rmi $IMAGE

deploy:
    stage: deploy
    image: alpine:3.16
    before_script:
      - export IMAGE="CI_REGISTRY_IMAGE:master-$CI_COMMIT_SHA"
      - apk update
      - apk add --no-cache git curl bash coreutils
      - mkdir /data/
      - cd /data

    script:
      - git clone https://${USER_DEPLOY}:${PASSWORD}@gitlab.com/devops5660826/argocd/helm-chart-app.git
      - git config --global user.email "phamduong812@gmail.com"
      - git config --global user.name "duongth"
      - ls -la
      - cd helm-chart-app
      - git checkout dev
      - ls -la
      - cd movie-app
      - echo $IMAGE
      - eval ''.image.tag' = "'master-$CI_COMMIT_SHA'"' -i values.yaml
      # - yq -i '.image.tag = "'master-$CI_COMMIT_SHA'"' values.yaml
      - git commit -am 'image update'
      - git push origin dev
    only:
      - develop
    tags:
      - docker
