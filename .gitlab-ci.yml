image: docker:latest
services:
  - docker:dind

stages:
  # - builddocker
  - deploy
before_script:
  - export IMAGE="$CI_REGISTRY_IMAGE:master-$CI_COMMIT_SHA"
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
# forbuilddocker:
#   stage: builddocker
#   tags: 
#     - docker
#   only:
#     - develop
#   script:
#     - docker build -t $IMAGE .
#     - docker push $IMAGE
#     - docker rmi $IMAGE

deploy:
    stage: deploy
    before_script:
      - mkdir /data/
      - cd /data
      - git clone https://${USER_DEPLOY}:${PASSWORD}@gitlab.com/devops5660826/argocd/helm-chart-app.git
      - git config --global user.email "phamduong812@gmail.com"
      - git config --global user.name "duongth"

    script:
      - cd helm-chart-app
      - git checkout dev
      - cd movie-app
      - ls -la
      - docker run --rm --user="root" -v "${PWD}":/workspace -w /workspace mikefarah/yq:4 eval ''.image.tag' = "'master-456'"' /workspace/values.yaml
      - git commit -am 'image update'
      - git push origin dev

    only:
      - develop
    tags:
      - docker
